<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skills Galaxy — Single File Demo (Patched)</title>
  <style>
    :root { --bg-1:#020417; --bg-2:#0b0e18; --bg-3:#07060a; }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto, "Helvetica Neue", Arial;background:radial-gradient(ellipse at bottom,var(--bg-1) 0%,var(--bg-2) 60%,var(--bg-3) 100%);color:#fff}
    canvas{width:100vw;height:100vh;display:block}
    .debug-overlay{position:fixed;right:12px;bottom:12px;width:360px;max-height:50vh;overflow:auto;background:rgba(0,0,0,0.56);border-radius:10px;padding:8px;font-size:12px;box-shadow:0 6px 18px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.04)}
    .debug-header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
    .debug-log{white-space:pre-wrap;font-family:monospace;color:#cbd5e1}
    .btn{background:rgba(255,255,255,0.06);color:white;border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:6px;cursor:pointer;font-size:12px}
    .level-select{background:rgba(255,255,255,0.04);color:#fff;border:none;padding:6px;border-radius:6px}
    .debug-log .entry{margin-bottom:8px;opacity:.85}
    .debug-log .entry.error{opacity:1;color:#ffb4b4}
    .debug-log pre{margin:4px 0 0 0;font-size:11px;max-height:120px;overflow:auto;background:rgba(255,255,255,0.02);padding:6px;border-radius:4px}
    .hint{position:fixed;left:12px;bottom:12px;background:rgba(255,255,255,0.04);border-radius:8px;padding:6px 10px;font-size:13px;color:#ddd;border:1px solid rgba(255,255,255,0.03)}
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <div class="hint">Pointer: hover to highlight • Click a planet to focus • Esc to reset</div>

  <div class="debug-overlay" role="status" aria-live="polite" id="debug">
    <div class="debug-header">
      <strong>Debug</strong>
      <div style="display:flex; gap:8px; align-items:center;">
        <select id="logLevel" class="level-select" aria-label="Log level">
          <option value="DEBUG">DEBUG</option>
          <option value="INFO">INFO</option>
          <option value="WARN">WARN</option>
          <option value="ERROR">ERROR</option>
        </select>
        <button id="downloadLogs" class="btn">Download</button>
      </div>
    </div>
    <div class="debug-log" id="debugLog"></div>
  </div>

  <!-- Importmap removed -->
  <script type="importmap">
{
  "imports": {
    "three": "./libs/three.webgpu.js",
    "three/webgpu": "./libs/three.webgpu.js",
    "three/tsl": "./libs/three.tsl.js",
    "three/addons/": "./libs/addons/"
  }
}
</script>

<script type="module">
import * as THREE from 'three/webgpu';
import { color, cos, float, mix, range, sin, time, uniform, uv, vec3, vec4, TWO_PI } from 'three/tsl';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { DRACOLoader } from './libs/DRACOLoader.js';
import { GLTFLoader } from './libs/GLTFLoader.js';
</script>

  <script type="module">
    // Using local module imports
    /**************************************************************************
     * Config & Data
     **************************************************************************/
    const CATEGORY_COLORS = {
      'AI & ML':'#00E6FF','Web Development':'#7C4DFF','Security':'#FF4D6D','Programming':'#FFD166',
      'Data Analysis':'#2ED573','Cloud & Data Engineering':'#2196F3','DevOps & Tools':'#FF8C42',
      'Strategy & Design':'#9B5DE5','Soft Skills':'#F9A8D4','Databases & SQL':'#3AA0FF',
      'Business & ERP':'#8D6E63','Marketing':'#FFC857','IT Fundamentals':'#6C757D'
    };

    // <-- IMPORTANT: relative paths (./models) so GH Pages and local servers resolve correctly -->
    const CATEGORY_MODEL_PATHS = {
  'AI & ML':'./models/ai_ml_node.glb',
  'Web Development':'./models/skill_node.glb',
  'Security':'./models/security_node.glb',
  'Programming':'./models/skill_node.glb',
  'Data Analysis':'./models/skill_node.glb',
  'Cloud & Data Engineering':'./models/skill_node.glb',
  'DevOps & Tools':'./models/skill_node.glb',
  'Strategy & Design':'./models/skill_node.glb',
  'Soft Skills':'./models/skill_node.glb',
  'Databases & SQL':'./models/skill_node.glb',
  'Business & ERP':'./models/skill_node.glb',
  'Marketing':'./models/skill_node.glb',
  'IT Fundamentals':'./models/skill_node.glb'
};

    const rawData = [ /* (unchanged rawData) */
      { title:"DESIGN RULES: Principles + Practices for Great UI Design", category:"Strategy & Design", date:"2025-07-31" },
      { title:"Material UI - The Complete Guide With React (2024) Edition", category:"Web Development", date:"2025-07-30" },
      { title:"Basic Git and Github - essentials", category:"DevOps & Tools", date:"2025-07-29" },
      { title:"Just Express (with a bunch of node and http). In detail.", category:"Web Development", date:"2025-07-28" },
      { title:"Secure Coding and Design Best Practices in NodeJs JavaScript", category:"Security", date:"2025-07-27" },
      { title:"Secure Coding - Secure application development", category:"Security", date:"2025-07-26" },
      { title:"Secure Coding - Ensuring Safe Deployment of Code", category:"Security", date:"2025-07-25" },
      { title:"C# Basics for Beginners: Learn C# Fundamentals by Coding", category:"Programming", date:"2025-07-24" },
      { title:"Diploma in Digital Transformation and Operational Excellence", category:"Strategy & Design", date:"2025-07-23" },
      { title:"The Ultimate Redux Course 2025 - [LATEST Redux-toolkit]", category:"Web Development", date:"2025-07-22" },
      { title:"Cypress End-to-End Testing - Getting Started", category:"DevOps & Tools", date:"2025-07-21" },
      { title:"Executive Briefing: Artificial Intelligence (AI) + ChatGPT", category:"AI & ML", date:"2025-07-20" },
      { title:"AWS Certified Data Engineer Associate (DEA-C01) Cert Prep", category:"Cloud & Data Engineering", date:"2025-10-06" },
      { title:"Programming Concepts for Python", category:"Programming", date:"2025-07-01" },
      { title:"Agentic Artificial Intelligence (AI)", category:"AI & ML", date:"2025-07-16" },
      { title:"Hands-On Generative AI with Multi-Agent LangChain: Building Real-World Applications", category:"AI & ML", date:"2025-07-16" },
      { title:"Designing Agentic AI Products (No Code Required)", category:"AI & ML", date:"2025-07-14" },
      { title:"Agentic AI Fundamentals: Architectures, Frameworks, and Applications", category:"AI & ML", date:"2025-07-14" },
      { title:"AIOps", category:"AI & ML", date:"2025-06-30" },
      { title:"Understanding Generative AI in Cloud Computing: Services and Use Cases (2023)", category:"Cloud & Data Engineering", date:"2025-06-30" },
      { title:"Applied AI for IT Operations (AIOps)", category:"AI & ML", date:"2025-06-24" },
      { title:"AIOps Foundations: Automating IT Operations using AI", category:"AI & ML", date:"2025-06-24" },
      { title:"Exploring AIOps", category:"AI & ML", date:"2025-06-13" },
      { title:"Success in Online Learning: Engage, Organize, and Upskill in the Age of AI", category:"Soft Skills", date:"2025-06-08" },
      { title:"Ideating on Business Goals with Design Thinking", category:"Strategy & Design", date:"2025-05-15" },
      { title:"Power BI Essential Training (2024)", category:"Data Analysis", date:"2024-07-17" },
      { title:"Working with Data Arrays in PostgreSQL", category:"Databases & SQL", date:"2024-11-05" },
      { title:"MySQL Advanced Topics", category:"Databases & SQL", date:"2024-10-22" },
      { title:"Learning Python (2021)", category:"Programming", date:"2024-10-08" },
      { title:"JavaScript as a Second Language", category:"Programming", date:"2024-09-12" },
      { title:"Database Foundations: Intro to Databases", category:"Databases & SQL", date:"2024-09-11" },
      { title:"Tackling Intense Customer Service Moments", category:"Soft Skills", date:"2024-09-11" },
      { title:"Learning the JavaScript Language", category:"Programming", date:"2024-08-19" },
      { title:"Java 8+ Essential Training: Syntax and Structure", category:"Programming", date:"2024-05-07" },
      { title:"Digital Application Development", category:"Web Development", date:"2024-05-07" },
      { title:"C# and .NET Essential Training", category:"Programming", date:"2024-06-17" },
      { title:"Data Science Foundations: Data Mining in Python", category:"Data Analysis", date:"2024-06-17" },
      { title:"Introduction to Business Analytics", category:"Data Analysis", date:"2024-06-13" },
      { title:"Learning ASP.NET Core MVC", category:"Web Development", date:"2024-06-06" },
      { title:"SAP Business Rule Framework (BRF+) Introduction", category:"Business & ERP", date:"2024-05-31" },
      { title:"How to Follow Up on a Job Application", category:"Soft Skills", date:"2024-05-17" },
      { title:"Learning Cloud Computing: Core Concepts", category:"Cloud & Data Engineering", date:"2024-05-14" },
      { title:"Programming Foundations: APIs and Web Services (2019)", category:"Web Development", date:"2024-05-14" },
      { title:"ASP.NET: Security", category:"Security", date:"2024-05-13" },
      { title:"Software Architecture: Patterns for Developers (2020)", category:"Programming", date:"2024-05-07" },
      { title:"Database Foundations: Application Development", category:"Databases & SQL", date:"2024-05-02" },
      { title:"Financial Analysis: Making Business Projections", category:"Strategy & Design", date:"2024-04-25" },
      { title:"Building AI Literacy", category:"AI & ML", date:"2024-04-26" },
      { title:"How to Boost Your Productivity with AI Tools (2023)", category:"AI & ML", date:"2024-04-26" },
      { title:"Responsible AI: Principles and Practical Applications", category:"AI & ML", date:"2024-04-26" },
      { title:"Introduction to Large Language Models", category:"AI & ML", date:"2024-04-26" },
      { title:"Prompt Engineering: How to Talk to the AIs", category:"AI & ML", date:"2024-04-25" },
      { title:"Career Essentials in Data Analysis by Microsoft and LinkedIn", category:"Data Analysis", date:"2024-03-20" },
      { title:"Learning Data Analytics: 1 Foundations", category:"Data Analysis", date:"2024-03-04" },
      { title:"Digital Marketing Foundations (2022)", category:"Marketing", date:"2024-04-25" },
      { title:"Getting Started with AI and Machine Learning", category:"AI & ML", date:"2024-04-24" },
      { title:"Artificial Intelligence Foundations: Neural Networks", category:"AI & ML", date:"2024-04-24" },
      { title:"Hands-On PyTorch Machine Learning", category:"AI & ML", date:"2024-04-22" },
      { title:"Reinforcement Learning Foundations", category:"AI & ML", date:"2024-04-22" },
      { title:"Building Computer Vision Applications with Python", category:"AI & ML", date:"2024-04-19" },
      { title:"Deep Learning: Getting Started", category:"AI & ML", date:"2024-04-17" },
      { title:"Machine Learning Foundations: Linear Algebra", category:"AI & ML", date:"2024-04-17" },
      { title:"Artificial Intelligence Foundations: Thinking Machines", category:"AI & ML", date:"2024-04-17" },
      { title:"Learning Data Analytics Part 2: Extending and Applying Core Knowledge", category:"Data Analysis", date:"2024-03-20" },
      { title:"React: Design Patterns (2021)", category:"Web Development", date:"2024-02-08" },
      { title:"CompTIA IT Fundamentals (FC0-U61) Cert Prep 1: Computer Basics, Hardware, and Operating Systems", category:"IT Fundamentals", date:"2024-02-06" },
      { title:"Introduction to Career Skills in Data Analytics", category:"Data Analysis", date:"2024-03-04" },
      { title:"OpenEDG Python Institute: Programming with Python Professional Certificate", category:"Programming", date:"2024-02-14" },
      { title:"Python Essential Training", category:"Programming", date:"2024-02-09" },
      { title:"CompTIA A+ Core 2 (220-1102) Cert Prep: 8 Portable Computing Security", category:"Security", date:"2024-02-23" },
      { title:"Building Blocks for Deep Learning in the Wolfram Language", category:"AI & ML", date:"2024-02-08" }
    ];

    /**************************************************************************
     * Logger
     **************************************************************************/
    const LOG_HISTORY_LIMIT = 800;
    const history = [];
    let overlayCallback = null;
    let minLevel = 'DEBUG';
    const levelOrder = { DEBUG:0, INFO:1, WARN:2, ERROR:3 };

    function shouldLog(level){ return levelOrder[level] >= levelOrder[minLevel]; }
    function _log(level, ctx, message, data){
      try {
        if(!shouldLog(level)) return;
        const entry = { ts:new Date().toISOString(), level, ctx, message, data };
        history.push(entry); if(history.length>LOG_HISTORY_LIMIT) history.shift();
        // console
        if(level==='ERROR') console.error(entry.ts, level, ctx, message, data);
        else if(level==='WARN') console.warn(entry.ts, level, ctx, message, data);
        else console.log(entry.ts, level, ctx, message, data);
        if(overlayCallback) overlayCallback(history.slice(-200).reverse());
      } catch(e){ console.warn('logger failure', e); }
    }
    const logger = {
      debug:(c,m,d)=>_log('DEBUG',c,m,d),
      info:(c,m,d)=>_log('INFO',c,m,d),
      warn:(c,m,d)=>_log('WARN',c,m,d),
      error:(c,m,d)=>_log('ERROR',c,m,d),
      setLevel:(l)=>{ minLevel = l; },
      registerOverlay:(cb)=>{ overlayCallback = cb; overlayCallback(history.slice(-200).reverse()); },
      getHistory:()=>history.slice()
    };

    /**************************************************************************
     * Utilities: probeUrl (HEAD fallback to GET) & probeAllModels
     **************************************************************************/
    async function probeUrl(url) {
      const ctx = 'probeUrl';
      try {
        // HEAD first
        const head = await fetch(url, { method: 'HEAD', cache:'no-store' });
        logger.debug(ctx, 'HEAD probe result', { url, status: head.status, ok: head.ok });
        return { ok: head.ok, status: head.status, url };
      } catch (headErr) {
        logger.warn(ctx, 'HEAD failed, trying GET', { url, err: String(headErr) });
        try {
          const get = await fetch(url, { method: 'GET', cache:'no-store' });
          logger.debug(ctx, 'GET probe result', { url, status: get.status, ok: get.ok });
          return { ok: get.ok, status: get.status, url };
        } catch (getErr) {
          logger.error(ctx, 'Both HEAD and GET failed for url', { url, err: String(getErr) });
          return { ok:false, status:null, url, error: String(getErr) };
        }
      }
    }

    async function probeAllModels() {
      const modelPaths = new Set(Object.values(CATEGORY_MODEL_PATHS));
      modelPaths.add('./models/central_core.glb');
modelPaths.add('./models/skill_node.glb');
modelPaths.add('./models/ai_ml_node.glb');
modelPaths.add('./models/security_node.glb');
      logger.info('probeAllModels', 'Probing model list', { modelCount: modelPaths.size, models: Array.from(modelPaths) });
      const results = {};
      for (const p of modelPaths) {
        try {
          const res = await probeUrl(p);
          results[p] = res;
          if (!res.ok) logger.warn('probeAllModels', 'Model unavailable or returned non-OK', res);
          else logger.info('probeAllModels', 'Model reachable', res);
          // Also print to console plainly for quick copy/paste
          console.log(`[MODEL PROBE] ${p} => status: ${res.status} ok: ${res.ok}`);
        } catch (err) {
          logger.error('probeAllModels', 'Probe failed for model', { path: p, err: String(err) });
          results[p] = { ok:false, status:null, err:String(err) };
        }
      }
      return results;
    }

    /**************************************************************************
     * Loaders & fallbacks
     **************************************************************************/
    const draco = new DRACOLoader();
draco.setDecoderPath('./libs/');
const gltfLoader = new GLTFLoader();
gltfLoader.setDRACOLoader(draco);
gltfLoader.crossOrigin = 'anonymous';

    function createFallbackPrimitive(category){
      const color = new THREE.Color(CATEGORY_COLORS[category] ?? '#ffffff');
      let geometry;
      switch (category){
        case 'AI & ML': geometry = new THREE.TorusKnotGeometry(0.8,0.25,128,16); break;
        case 'Web Development': geometry = new THREE.OctahedronGeometry(0.9,2); break;
        case 'Security': geometry = new THREE.DodecahedronGeometry(0.9,1); break;
        case 'Programming': geometry = new THREE.IcosahedronGeometry(0.9,1); break;
        case 'Data Analysis': geometry = new THREE.CylinderGeometry(0.6,0.6,1.2,16); break;
        case 'Cloud & Data Engineering': geometry = new THREE.SphereGeometry(0.9,24,24); break;
        case 'DevOps & Tools': geometry = new THREE.TorusGeometry(0.9,0.2,16,100); break;
        case 'Strategy & Design': geometry = new THREE.ConeGeometry(0.8,1.4,16); break;
        case 'Soft Skills': geometry = new THREE.TorusGeometry(0.7,0.15,16,100); break;
        case 'Databases & SQL': geometry = new THREE.BoxGeometry(1.0,1.0,1.0); break;
        case 'Business & ERP': geometry = new THREE.ConeGeometry(0.9,1.2,20); break;
        case 'Marketing': geometry = new THREE.CylinderGeometry(0.7,0.7,1.3,12); break;
        case 'IT Fundamentals': geometry = new THREE.OctahedronGeometry(0.8,1); break;
        default: geometry = new THREE.SphereGeometry(0.9,12,12);
      }
      const mat = new THREE.MeshStandardMaterial({ color, emissive: color.clone().multiplyScalar(0.2), roughness:0.6, metalness:0.2 });
      return new THREE.Mesh(geometry, mat);
    }

    async function loadCategoryModel(category) {
      const ctx = `loadCategoryModel:${category}`;
      const path = CATEGORY_MODEL_PATHS[category];
      if (!path) {
        logger.warn(ctx, 'No model path configured; using fallback primitive', { category });
        return createFallbackPrimitive(category);
      }
      // Probe first
      const probe = await probeUrl(path);
      if (!probe.ok) {
        logger.warn(ctx, 'Probe indicates model not reachable; using fallback', { path, probe });
        return createFallbackPrimitive(category);
      }
      // If reachable, attempt loader
      try {
        logger.debug(ctx, 'Loading via GLTFLoader', { path });
        const gltf = await gltfLoader.loadAsync(path);
        const obj = gltf.scene || gltf;
        // Normalize scale
        const box = new THREE.Box3().setFromObject(obj);
        const size = box.getSize(new THREE.Vector3());
        const maxSide = Math.max(size.x, size.y, size.z, 1e-6);
        const target = 1.8;
        const scale = target / maxSide;
        obj.scale.setScalar(scale);
        logger.info(ctx, 'Loaded GLB and scaled', { path, status:'loaded', scale, originalSize: size });
        return obj;
      } catch (err) {
        logger.error(ctx, 'GLTFLoader failed; falling back', { path, error: String(err) });
        return createFallbackPrimitive(category);
      }
    }

    /**************************************************************************
     * Galaxy scene
     **************************************************************************/
    const canvas = document.getElementById('canvas');
    let renderer, scene, camera, controls;
    let planetMeshes = [];
    const categoryGroups = new Map();

    function mapToGalaxyItems(data) {
      const now = Date.now();
      const maxDays = 365 * 1.2;
      return data.map((d, idx) => {
        const daysAgo = (now - new Date(d.date).getTime()) / (1000*3600*24);
        const radius = 2 + Math.min(1, daysAgo / maxDays) * 10;
        const angle = ((idx / data.length) * Math.PI * 2) + (Math.random() * 0.3);
        const x = radius * Math.cos(angle);
        const y = (Math.random() - 0.5) * 2;
        const z = radius * Math.sin(angle);
        const orbitPeriod = 12 + Math.random() * 24;
        return Object.assign({}, d, { position: [x,y,z], radius, orbitPeriod });
      });
    }

    async function ensureCategoryGroup(category) {
      if (categoryGroups.has(category)) return categoryGroups.get(category);
      const group = new THREE.Group(); group.name = `group-${category}`;
      const pl = new THREE.PointLight(0xffffff, 0.9, 8);
      group.add(pl); scene.add(group); categoryGroups.set(category, group);
      try {
        const model = await loadCategoryModel(category);
        model.position.set(0,0,0); group.add(model); // animate entrance lightly
        window.gsap?.fromTo(model.scale, { x:0.2,y:0.2,z:0.2 }, { x:model.scale.x||1, y:model.scale.y||1, z:model.scale.z||1, duration:0.9, ease:'power2.out' });
      } catch (err) {
        logger.error('ensureCategoryGroup', 'loadCategoryModel threw', String(err));
      }
      return group;
    }

    function createFallbackPlanetMaterial(category) {
      const c = CATEGORY_COLORS[category] || '#ffffff';
      const color = new THREE.Color(c);
      return new THREE.MeshStandardMaterial({ color, emissive: color.clone().multiplyScalar(0.25), metalness:0.2, roughness:0.6 });
    }

    async function init() {
      try {
        logger.info('App', 'Initializing scene and probing models first');
        // probe all model URLs and log statuses (console + debug overlay)
        const probeResults = await probeAllModels();
        logger.debug('App', 'Model probe results summary', probeResults);

        // renderer
        const reduceMode = (navigator.deviceMemory || 4) <= 1 || (navigator.hardwareConcurrency || 4) <= 2;
        renderer = new THREE.WebGPURenderer({ antialias: true });
		renderer.setPixelRatio(window.devicePixelRatio);
		renderer.setSize(window.innerWidth, window.innerHeight);
		function animate() {
      try {
        const dt = clock.getDelta();
        const t = clock.getElapsedTime();
        scene.rotation.y += dt * 0.01;
        planetMeshes.forEach(m=>{
          const u = m.userData;
          if(!u) return;
          const angle = (t / (u.orbitPeriod || 18)) * Math.PI * 2;
          const r = u.radius || 6;
          m.position.set(r * Math.cos(angle), m.position.y, r * Math.sin(angle));
        });
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(planetMeshes, false);
        if(intersects.length>0){
          const obj = intersects[0].object;
          if(hovered !== obj){
            if(hovered) { window.gsap?.to(hovered.scale,{x:1,y:1,z:1,duration:0.22}); }
            hovered = obj;
            window.gsap?.to(obj.scale,{x:1.25,y:1.25,z:1.25,duration:0.22});
          }
        } else {
          if(hovered){ window.gsap?.to(hovered.scale,{x:1,y:1,z:1,duration:0.22}); hovered=null; }
        }
        controls.update();
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      } catch(e){ logger.error('App.animate','animation loop failed',String(e)); }
    }
    animate();

    // Handle window resize
    window.addEventListener('resize', ()=>{ try{ camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); } catch(e){ logger.error('App.onResize','resize failed',String(e)); } });
		document.body.appendChild(renderer.domElement);

		controls = new OrbitControls(camera, renderer.domElement);
		controls.enableDamping = true;
		controls.minDistance = 0.1;
		controls.maxDistance = 50;

        // scene & camera
        scene = new THREE.Scene();
		scene.background = new THREE.Color(0x201919);
        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
		camera.position.set(4, 2, 5);

        // controls
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.08;
        controls.minDistance = 3; controls.maxDistance = 40; controls.maxPolarAngle = Math.PI*0.9;

        // ambient
        const ambient = new THREE.AmbientLight(0x11121a, 1.0); scene.add(ambient);

        // Atomic particle system
        const material = new THREE.SpriteNodeMaterial({
            depthWrite: false,
            blending: THREE.AdditiveBlending
        });

        // Protons (core particles)
        const protonSize = uniform(0.1);
        material.scaleNode = range(0, 1).mul(protonSize);

        // Atomic structure parameters
        const radiusRatio = range(0, 1);
        const radius = radiusRatio.pow(1.5).mul(5).toVar();

        // Electron shells (3 orbitals)
        const orbitals = 3;
        const orbitalAngle = range(0, orbitals).floor().mul(TWO_PI.div(orbitals));
        const angle = orbitalAngle.add(time.mul(radiusRatio.oneMinus()));

        // Particle positions
        const position = vec3(
            cos(angle),
            0,
            sin(angle)
        ).mul(radius);

        // Neutron cloud effect
        const randomOffset = range(vec3(-1), vec3(1)).pow3().mul(radiusRatio).add(0.2);

        material.positionNode = position.add(randomOffset);

        // Element colors (gold nucleus, blue electron cloud)
        const coreColor = uniform(color('#ffd700'));
        const cloudColor = uniform(color('#1a75ff'));
        const finalColor = mix(coreColor, cloudColor, radiusRatio.oneMinus().pow(2).oneMinus());
        const alpha = float(0.1).div(uv().sub(0.5).length()).sub(0.2);
        material.colorNode = vec4(finalColor, alpha);

        // Create particle system (20,000 particles)
        const particles = new THREE.InstancedMesh(new THREE.PlaneGeometry(1, 1), material, 20000);
        scene.add(particles);

        // planets (async ensure categories)
        const items = mapToGalaxyItems(rawData);
        planetMeshes = [];
        const planetGeo = new THREE.IcosahedronGeometry(0.22, reduceMode?0:2);
        const materialCache = new Map();

        for (let idx=0; idx<items.length; idx++){
          const item = items[idx];
          const group = await ensureCategoryGroup(item.category);
          let mat = materialCache.get(item.category);
          if(!mat){ mat = createFallbackPlanetMaterial(item.category); materialCache.set(item.category, mat); }
          const mesh = new THREE.Mesh(planetGeo, mat);
          mesh.position.set(...item.position); mesh.scale.set(1,1,1); mesh.userData = item; mesh.name = `planet-${idx}`;
          group.add(mesh); planetMeshes.push(mesh);
          // entrance
          window.gsap?.fromTo(mesh.position, { x:0,y:0,z:0 }, { x:mesh.position.x, y:mesh.position.y, z:mesh.position.z, duration: 1.4, delay: idx*0.02, ease:'power3.out' });
        }
        logger.info('App', 'Planets created', { planetCount: planetMeshes.length });

        // interactions
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let hovered = null;

        function onPointerMove(e){
          mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
          mouse.y = - (e.clientY / window.innerHeight) * 2 + 1;
        }
        function onClick(){
          try {
            if(!hovered) return;
            const item = hovered.userData;
            logger.info('App', 'Planet clicked', { name: hovered.name, item });
            if(item) alert(`Selected: ${item.title}\nCategory: ${item.category}\nDate: ${item.date}`);
            const pos = hovered.getWorldPosition(new THREE.Vector3());
            window.gsap.to(camera.position, { x: pos.x + 3, y: pos.y + 2, z: pos.z + 6, duration: 0.9, ease: 'power2.inOut' });
            window.gsap.to(controls.target, { x: pos.x, y: pos.y, z: pos.z, duration: 0.9, ease: 'power2.inOut' });
          } catch (err) { logger.error('App.onClick','click failed',String(err)); }
        }

        window.addEventListener('pointermove', onPointerMove);
        window.addEventListener('click', onClick);

        window.addEventListener('error', (ev) => logger.error('window.onerror', ev.message, { filename: ev.filename, lineno: ev.lineno, colno: ev.colno, error: ev.error }));
        window.addEventListener('unhandledrejection', (ev)=> logger.error('unhandledrejection','Promise rejected', ev.reason));

        const clock = new THREE.Clock();
        function loop(){
          try {
            const dt = clock.getDelta();
            const t = clock.getElapsedTime();
            scene.rotation.y += dt * 0.01;
            planetMeshes.forEach(m=>{
              const u = m.userData;
              if(!u) return;
              const angle = (t / (u.orbitPeriod || 18)) * Math.PI * 2;
              const r = u.radius || 6;
              m.position.set(r * Math.cos(angle), m.position.y, r * Math.sin(angle));
            });
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(planetMeshes, false);
            if(intersects.length>0){
              const obj = intersects[0].object;
              if(hovered !== obj){
                if(hovered) { window.gsap?.to(hovered.scale,{x:1,y:1,z:1,duration:0.22}); }
                hovered = obj;
                window.gsap?.to(obj.scale,{x:1.25,y:1.25,z:1.25,duration:0.22});
              }
            } else {
              if(hovered){ window.gsap?.to(hovered.scale,{x:1,y:1,z:1,duration:0.22}); hovered=null; }
            }
            controls.update();
            renderer.render(scene, camera);
            requestAnimationFrame(loop);
          } catch(e){ logger.error('App.loop','render loop failed',String(e)); }
        }
        requestAnimationFrame(loop);

        // resize
        window.addEventListener('resize', ()=>{ try{ camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); } catch(e){ logger.error('App.onResize','resize failed',String(e)); } });

        // esc reset
        window.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape'){ window.gsap?.to(camera.position,{x:0,y:4,z:14,duration:0.9}); window.gsap?.to(controls.target,{x:0,y:0,z:0,duration:0.9}); } });
      } catch (err) {
        logger.error('App.init','initialization failed',String(err));
      }
    }

    // --- Start app ---
    init();

    /**************************************************************************
     * Debug overlay wiring
     **************************************************************************/
    const debugLogEl = document.getElementById('debugLog');
    const logLevelSelect = document.getElementById('logLevel');
    const downloadBtn = document.getElementById('downloadLogs');

    function renderLogs(entries) {
      debugLogEl.innerHTML = '';
      entries.slice(0,100).forEach(l=>{
        const div = document.createElement('div');
        div.className = 'entry' + (l.level==='ERROR' ? ' error' : '');
        const header = document.createElement('div');
        header.textContent = `[${l.ts}] [${l.level}] ${l.ctx ?? 'app'} — ${l.message}`;
        div.appendChild(header);
        if(l.data){
          const pre = document.createElement('pre');
          pre.textContent = JSON.stringify(l.data, null, 2);
          div.appendChild(pre);
        }
        debugLogEl.appendChild(div);
      });
    }

    logger.registerOverlay((h)=>{ try{ renderLogs(h); } catch(e){ console.warn('renderLogs fail', e); } });

    logLevelSelect.value = 'DEBUG';
    logLevelSelect.addEventListener('change', (e)=>{ const v=e.target.value; logger.setLevel(v); logger.info('DebugOverlay','Log level changed',{level:v}); });
    downloadBtn.addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify(logger.getHistory(),null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'skills-galaxy-logs.json'; a.click(); URL.revokeObjectURL(url); });

    logger.info('App', 'Patched Skills Galaxy loaded — model probe and relative paths active. Use ./models/*.glb and ./draco/ (optional).');
  </script>
</body>
</html>