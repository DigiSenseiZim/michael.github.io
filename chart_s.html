<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Skills Galaxy — 2025</title>

  <style>
    /* --- Base --- */
    :root{--glass: rgba(10,12,20,0.55);--accent:#7be7ff;--muted:#98a0b3;--panel:#071126}
    *{box-sizing:border-box}
    html,body{height:100%;width:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;}
    body{background: radial-gradient(1200px 700px at 10% 10%,#001226 0%, #00040a 28%, #000 100%);color:#dfefff;overflow:hidden}

    /* Canvas container */
    #canvas-container{position:fixed;inset:0;z-index:1}

    /* HUD */
    #title{position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:60;font-weight:700;padding:8px 14px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.04)}
    #controls{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);z-index:60;display:flex;gap:8px;padding:8px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.03)}
    .btn{padding:8px 12px;border-radius:8px;border:0;color:#041229;background:linear-gradient(180deg,var(--accent),#5fb8d6);cursor:pointer;font-weight:600}
    .btn.secondary{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)}

    /* Info panel */
    #info-panel{position:fixed;right:20px;top:70px;z-index:70;width:340px;max-height:70vh;overflow:auto;padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(8,10,18,0.7),rgba(6,8,14,0.6));border:1px solid rgba(255,255,255,0.04);backdrop-filter: blur(8px);box-shadow:0 8px 30px rgba(0,0,0,0.6);opacity:0;pointer-events:none;transition:all 300ms ease}
    #info-panel.visible{opacity:1;pointer-events:auto}
    #info-panel h3{margin:0 0 8px 0;color:var(--accent);font-size:1.15rem}
    #info-panel .meta{color:var(--muted);font-size:0.9rem;margin-bottom:12px}
    .skill-row{padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);display:flex;align-items:center;gap:10px}
    .skill-dot{width:12px;height:12px;border-radius:50%}
    .skill-title{font-size:0.95rem;color:#eaf6ff}
    .skill-date{margin-left:auto;color:var(--muted);font-size:0.8rem}

    /* Floating label used for hovered node */
    .floating-label{position:fixed;z-index:80;padding:6px 10px;border-radius:8px;background:rgba(0,6,12,0.65);border:1px solid rgba(255,255,255,0.04);pointer-events:none;font-weight:600;font-size:0.9rem;display:none;opacity:0;transform:translate(-50%,-100%)}

    /* Loading */
    #loading{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1000;background:var(--panel);padding:14px 18px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 40px rgba(0,0,0,0.6)}

    /* small helper for connections overlay if needed */
    .hint{position:fixed;left:20px;bottom:22px;color:var(--muted);font-size:0.85rem;z-index:60}

    @media (max-width:720px){#info-panel{right:8px;left:8px;width:auto}}
  </style>
</head>
<body>
  <div id="canvas-container"></div>
  <div id="title">Skills Galaxy — 2025</div>
  <div id="controls">
    <button class="btn" id="toggle-rotation">Pause</button>
    <button class="btn secondary" id="reset-view">Reset</button>
    <button class="btn secondary" id="focus-mode">Focus</button>
    <button class="btn secondary" id="toggle-connections">Hide Lines</button>
  </div>

  <div id="info-panel">
    <h3 id="panel-title">Category</h3>
    <div class="meta" id="panel-meta">0 skills · latest — —</div>
    <div id="skills-list"></div>
  </div>

  <div id="loading">Loading 3D models and building galaxy…</div>
  <div class="hint">Tip: hover category nodes — click to zoom in · drag to rotate</div>

  <script type="module">
    // --- START OF SCRIPT ---
    console.log("--- SKILLS GALAXY SCRIPT (V3 - With Logging) LOADED ---");
    
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/loaders/GLTFLoader.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/controls/OrbitControls.js';
    import { gsap } from 'https://cdn.jsdelivr.net/npm/gsap@3.12.2/index.js';

    // Make imports globally available for the main script
    window.THREE = THREE;
    window.GLTFLoader = GLTFLoader;
    window.OrbitControls = OrbitControls;
    window.gsap = gsap;

    // ---------------------------
    // Data
    // ---------------------------
    const rawData = [
        { title: "DESIGN RULES: Principles + Practices for Great UI Design", category: "Strategy & Design", date: "2025-07-31" },
        { title: "Material UI - The Complete Guide With React (2024) Edition", category: "Web Development", date: "2025-07-30" },
        { title: "Basic Git and Github - essentials", category: "DevOps & Tools", date: "2025-07-29" },
        { title: "Just Express (with a bunch of node and http). In detail.", category: "Web Development", date: "2025-07-28" },
        { title: "Secure Coding and Design Best Practices in NodeJs JavaScript", category: "Security", date: "2025-07-27" },
        { title: "Secure Coding - Secure application development", category: "Security", date: "2025-07-26" },
        { title: "Secure Coding - Ensuring Safe Deployment of Code", category: "Security", date: "2025-07-25" },
        { title: "C# Basics for Beginners: Learn C# Fundamentals by Coding", category: "Programming", date: "2025-07-24" },
        { title: "Diploma in Digital Transformation and Operational Excellence", category: "Strategy & Design", date: "2025-07-23" },
        { title: "The Ultimate Redux Course 2025 - [LATEST Redux-toolkit]", category: "Web Development", date: "2025-07-22" },
        { title: "Cypress End-to-End Testing - Getting Started", category: "DevOps & Tools", date: "2025-07-21" },
        { title: "Executive Briefing: Artificial Intelligence (AI) + ChatGPT", category: "AI & ML", date: "2025-07-20" },
        { title: "AWS Certified Data Engineer Associate (DEA-C01) Cert Prep", category: "Cloud & Data Engineering", date: "2025-10-06" },
        { title: "Programming Concepts for Python", category: "Programming", date: "2025-07-01" },
        { title: "Agentic Artificial Intelligence (AI)", category: "AI & ML", date: "2025-07-16" },
        { title: "Hands-On Generative AI with Multi-Agent LangChain: Building Real-World Applications", category: "AI & ML", date: "2025-07-16" },
        { title: "Designing Agentic AI Products (No Code Required)", category: "AI & ML", date: "2025-07-14" },
        { title: "Agentic AI Fundamentals: Architectures, Frameworks, and Applications", category: "AI & ML", date: "2025-07-14" },
        { title: "AIOps", category: "AI & ML", date: "2025-06-30" },
        { title: "Understanding Generative AI in Cloud Computing: Services and Use Cases (2023)", category: "Cloud & Data Engineering", date: "2025-06-30" },
        { title: "Applied AI for IT Operations (AIOps)", category: "AI & ML", date: "2025-06-24" },
        { title: "AIOps Foundations: Automating IT Operations using AI", category: "AI & ML", date: "2025-06-24" },
        { title: "Exploring AIOps", category: "AI & ML", date: "2025-06-13" },
        { title: "Success in Online Learning: Engage, Organize, and Upskill in the Age of AI", category: "Soft Skills", date: "2025-06-08" },
        { title: "Ideating on Business Goals with Design Thinking", category: "Strategy & Design", date: "2025-05-15" },
        { title: "Power BI Essential Training (2024)", category: "Data Analysis", date: "2024-07-17" },
        { title: "Working with Data Arrays in PostgreSQL", category: "Databases & SQL", date: "2024-11-05" },
        { title: "MySQL Advanced Topics", category: "Databases & SQL", date: "2024-10-22" },
        { title: "Learning Python (2021)", category: "Programming", date: "2024-10-08" },
        { title: "JavaScript as a Second Language", category: "Programming", date: "2024-09-12" },
        { title: "Database Foundations: Intro to Databases", category: "Databases & SQL", date: "2024-09-11" },
        { title: "Tackling Intense Customer Service Moments", category: "Soft Skills", date: "2024-09-11" },
        { title: "Learning the JavaScript Language", category: "Programming", date: "2024-08-19" },
        { title: "Java 8+ Essential Training: Syntax and Structure", category: "Programming", date: "2024-05-07" },
        { title: "Digital Application Development", category: "Web Development", date: "2024-05-07" },
        { title: "C# and .NET Essential Training", category: "Programming", date: "2024-06-17" },
        { title: "Data Science Foundations: Data Mining in Python", category: "Data Analysis", date: "2024-06-17" },
        { title: "Introduction to Business Analytics", category: "Data Analysis", date: "2024-06-13" },
        { title: "Learning ASP.NET Core MVC", category: "Web Development", date: "2024-06-06" },
        { title: "SAP Business Rule Framework (BRF+) Introduction", category: "Business & ERP", date: "2024-05-31" },
        { title: "How to Follow Up on a Job Application", category: "Soft Skills", date: "2024-05-17" },
        { title: "Learning Cloud Computing: Core Concepts", category: "Cloud & Data Engineering", date: "2024-05-14" },
        { title: "Programming Foundations: APIs and Web Services (2019)", category: "Web Development", date: "2024-05-14" },
        { title: "ASP.NET: Security", category: "Security", date: "2024-05-13" },
        { title: "Software Architecture: Patterns for Developers (2020)", category: "Programming", date: "2024-05-07" },
        { title: "Database Foundations: Application Development", category: "Databases & SQL", date: "2024-05-02" },
        { title: "Financial Analysis: Making Business Projections", category: "Strategy & Design", date: "2024-04-25" },
        { title: "Building AI Literacy", category: "AI & ML", date: "2024-04-26" },
        { title: "How to Boost Your Productivity with AI Tools (2023)", category: "AI & ML", date: "2024-04-26" },
        { title: "Responsible AI: Principles and Practical Applications", category: "AI & ML", date: "2024-04-26" },
        { title: "Introduction to Large Language Models", category: "AI & ML", date: "2024-04-26" },
        { title: "Prompt Engineering: How to Talk to the AIs", category: "AI & ML", date: "2024-04-25" },
        { title: "Career Essentials in Data Analysis by Microsoft and LinkedIn", category: "Data Analysis", date: "2024-03-20" },
        { title: "Learning Data Analytics: 1 Foundations", category: "Data Analysis", date: "2024-03-04" },
        { title: "Digital Marketing Foundations (2022)", category: "Marketing", date: "2024-04-25" },
        { title: "Getting Started with AI and Machine Learning", category: "AI & ML", date: "2024-04-24" },
        { title: "Artificial Intelligence Foundations: Neural Networks", category: "AI & ML", date: "2024-04-24" },
        { title: "Hands-On PyTorch Machine Learning", category: "AI & ML", date: "2024-04-22" },
        { title: "Reinforcement Learning Foundations", category: "AI & ML", date: "2024-04-22" },
        { title: "Building Computer Vision Applications with Python", category: "AI & ML", date: "2024-04-19" },
        { title: "Deep Learning: Getting Started", category: "AI & ML", date: "2024-04-17" },
        { title: "Machine Learning Foundations: Linear Algebra", category: "AI & ML", date: "2024-04-17" },
        { title: "Artificial Intelligence Foundations: Thinking Machines", category: "AI & ML", date: "2024-04-17" },
        { title: "Learning Data Analytics Part 2: Extending and Applying Core Knowledge", category: "Data Analysis", date: "2024-03-20" },
        { title: "React: Design Patterns (2021)", category: "Web Development", date: "2024-02-08" },
        { title: "CompTIA IT Fundamentals (FC0-U61) Cert Prep 1: Computer Basics, Hardware, and Operating Systems", category: "IT Fundamentals", date: "2024-02-06" },
        { title: "Introduction to Career Skills in Data Analytics", category: "Data Analysis", date: "2024-03-04" },
        { title: "OpenEDG Python Institute: Programming with Python Professional Certificate", category: "Programming", date: "2024-02-14" },
        { title: "Python Essential Training", category: "Programming", date: "2024-02-09" },
        { title: "CompTIA A+ Core 2 (220-1102) Cert Prep: 8 Portable Computing Security", category: "Security", date: "2024-02-23" },
        { title: "Building Blocks for Deep Learning in the Wolfram Language", category: "AI & ML", date: "2024-02-08" }
    ];

    // ---------------------------
    // Visual config
    // ---------------------------
    const categoryColors = {
      "AI & ML": 0xff6b6b,
      "Web Development": 0x4ecdc4,
      "Programming": 0x45b7d1,
      "Security": 0x96ceb4,
      "Strategy & Design": 0xffcc5c,
      "DevOps & Tools": 0xff8c94,
      "Cloud & Data Engineering": 0x5a7d9a,
      "Data Analysis": 0x9b59b6,
      "Databases & SQL": 0x3498db,
      "Soft Skills": 0xe74c3c,
      "Marketing": 0x2ecc71,
      "Business & ERP": 0xf39c12,
      "IT Fundamentals": 0x16a085
    };

    const categoryImportance = {
      "AI & ML": 10,
      "Cloud & Data Engineering": 9,
      "Security": 9,
      "Web Development": 8,
      "Data Analysis": 8,
      "Programming": 7,
      "DevOps & Tools": 7,
      "Strategy & Design": 6,
      "Databases & SQL": 6,
      "Business & ERP": 5,
      "Soft Skills": 5,
      "Marketing": 4,
      "IT Fundamentals": 3
    };

    const categoryModels = { 
      "AI & ML": "models/ai_ml_node.glb", 
      "Web Development": "models/web_dev_node.glb", 
      "Programming": "models/programming_node.glb", 
      "Security": "models/security_node.glb", 
      "Strategy & Design": "models/state.glb", 
      "DevOps & Tools": "models/state.glb", 
      "Cloud & Data Engineering": "models/state.glb", 
      "Data Analysis": "models/state.glb", 
      "Databases & SQL": "models/state.glb", 
      "Soft Skills": "models/state.glb", 
      "Marketing": "models/state.glb", 
      "Business & ERP": "models/state.glb", 
      "IT Fundamentals": "models/state.glb" 
    };

    // ---------------------------
    // State
    // ---------------------------
    let scene, camera, renderer, controls, galaxyGroup, connectionsGroup, stars;
    let raycaster, mouse = new THREE.Vector2();
    let categoryNodes = [], skillNodes = [], connections = [];
    let isRotating = true, showConnections = true, focusMode = false, focusedNode = null;
    const labels = new Map(); // HTML labels for skill nodes

    // Small utilities
    function formatDate(d){ try{ const dt=new Date(d); return dt.toISOString().slice(0,10);}catch(e){return d} }

    // Fibonacci sphere used for even distribution
    function fibonacciSphere(numPoints, radius = 1){
      const points = [];
      const phi = Math.PI * (3 - Math.sqrt(5));
      for(let i=0;i<numPoints;i++){
        const y = 1 - (i / (numPoints - 1)) * 2; // -1..1
        const r = Math.sqrt(1 - y*y);
        const theta = phi * i;
        const x = Math.cos(theta) * r;
        const z = Math.sin(theta) * r;
        points.push(new THREE.Vector3(x*radius, y*radius, z*radius));
      }
      return points;
    }

    async function init() {
      console.log("Booting galaxy...");
      const container = document.getElementById('canvas-container');
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x00010a);
      scene.fog = new THREE.FogExp2(0x00010a, 0.0035);

      camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
      camera.position.set(0,18,70);

      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      container.appendChild(renderer.domElement);

      const hemi = new THREE.HemisphereLight(0x6b8190, 0x06111a, 0.7);
      scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff, 0.9);
      dir.position.set(30,60,50);
      dir.castShadow = true;
      dir.shadow.camera.left = -100;
      dir.shadow.camera.right = 100;
      dir.shadow.camera.top = 100;
      dir.shadow.camera.bottom = -100;
      scene.add(dir);

      galaxyGroup = new THREE.Group();
      scene.add(galaxyGroup);
      connectionsGroup = new THREE.Group();
      scene.add(connectionsGroup);

      raycaster = new THREE.Raycaster();

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.enablePan = false;

      window.addEventListener('resize', onResize);
      renderer.domElement.addEventListener('mousemove', onMouseMove);
      renderer.domElement.addEventListener('click', onClick);

      document.getElementById('toggle-rotation').addEventListener('click', () => {
        isRotating = !isRotating;
        document.getElementById('toggle-rotation').textContent = isRotating ? 'Pause' : 'Play';
      });
      document.getElementById('reset-view').addEventListener('click', () => {
        gsap.to(camera.position, { x:0, y:18, z:70, duration:1.2, ease:'power2.out' });
        focusMode = false;
        focusedNode = null;
        restoreAll();
      });
      document.getElementById('toggle-connections').addEventListener('click', () => {
        showConnections = !showConnections;
        connectionsGroup.visible = showConnections;
        document.getElementById('toggle-connections').textContent = showConnections ? 'Hide Lines' : 'Show Lines';
      });
      document.getElementById('focus-mode').addEventListener('click', () => {
        if (focusMode) exitFocusMode();
        else if (focusedNode) enterFocusMode(focusedNode);
      });

      await loadAllModels();
      createStarfield();
      buildGalaxy();
      document.getElementById('loading').style.display = 'none';

      animate();
    }

    async function loadAllModels() {
      console.log("Attempting to load all models...");
      const loader = new GLTFLoader();
      window._loadedModels = {};

      // core & skill
      const corePromise  = loader.loadAsync('models/central_core.glb').then(g => normalizeModelScale(g.scene, 5)).catch(() => createFallbackCore());
      const skillPromise = loader.loadAsync('models/skill_node.glb').then(g => normalizeModelScale(g.scene, 0.8)).catch(() => createFallbackSkill());

      // category model promises
      const categoryEntries = Object.entries(categoryModels).map(async ([category, path]) => {
        console.log(`Loading model: ${category} from ${path}`);
        try {
          const gltf = await loader.loadAsync(path);
          const importance = categoryImportance[category] || 5;
          const targetSize = 1.5 + (importance/10)*2;
          return [category, normalizeModelScale(gltf.scene, targetSize)];
        } catch(e) {
          console.warn(`Failed to load ${category} model from ${path}, using fallback`);
          return [category, createFallbackCategory(category)];
        }
      });

      const categoryResults = await Promise.all(categoryEntries);
      categoryResults.forEach(([category, model]) => window._loadedModels[category] = model);

      window._loadedModels.core  = await corePromise;
      window._loadedModels.skill = await skillPromise;

      return window._loadedModels;
    }

    function normalizeModelScale(model, targetSize=1) {
      const box = new THREE.Box3().setFromObject(model);
      const size = box.getSize(new THREE.Vector3());
      const maxDim = Math.max(size.x, size.y, size.z);
      const scale = targetSize / (maxDim || 1);
      model.scale.set(scale, scale, scale);
      model.position.set(0,0,0);
      return model;
    }

    function createFallbackCore() {
      const geometry = new THREE.IcosahedronGeometry(5, 2);
      const material = new THREE.MeshStandardMaterial({
        color: 0xffd166,
        emissive: 0xffd166,
        emissiveIntensity: 0.3,
        roughness: 0.35,
        metalness: 0.15
      });
      return new THREE.Mesh(geometry, material);
    }

    function createFallbackSkill() {
      const geometry = new THREE.OctahedronGeometry(0.45,0);
      const material = new THREE.MeshStandardMaterial({
        color: 0xffffff,
        emissive: 0x444444,
        emissiveIntensity: 0.35,
        roughness: 0.3
      });
      return new THREE.Mesh(geometry, material);
    }

    function createFallbackCategory(category) {
      const importance = categoryImportance[category] || 5;
      const size = 1.8 + (importance/10)*3.2;
      const geometry = new THREE.OctahedronGeometry(size, 1);
      geometry.computeBoundingBox();
      const colour = categoryColors[category] || 0x8ab4ff;
      const material = new THREE.MeshStandardMaterial({
        color: colour,
        emissive: colour,
        emissiveIntensity: 0.18,
        roughness: 0.25,
        metalness: 0.25
      });
      const mesh = new THREE.Mesh(geometry, material);
      mesh.position.set(0,0,0);
      return mesh;
    }
    
    // ---------------------------
    // Create connection between nodes
    // ---------------------------
    function createConnection(nodeA, nodeB) {
      if(!nodeA || !nodeB) return;
      
      const pts = new Float32Array([
        nodeA.position.x, nodeA.position.y, nodeA.position.z, 
        nodeB.position.x, nodeB.position.y, nodeB.position.z
      ]);
      
      const g = new THREE.BufferGeometry(); 
      g.setAttribute('position', new THREE.BufferAttribute(pts,3));
      g.computeBoundingSphere();
      
      const mat = new THREE.LineBasicMaterial({ 
        color: 0x4a6ea9,
        transparent: true, 
        opacity: 0.4,
        linewidth: 1
      });
      
      const line = new THREE.Line(g, mat);
      connectionsGroup.add(line);
      connections.push(line);
      return line;
    }

    // ---------------------------
    // Build galaxy with loaded models
    // ---------------------------
    function buildGalaxy() {
      // Create central core
      const core = window._loadedModels.core.clone();
      core.position.set(0, 0, 0);
      galaxyGroup.add(core);
      core.userData = { type: 'core' };

      // Process raw data into skill groups by category
      const skillGroups = {};
      rawData.forEach(skill => {
          if (!skillGroups[skill.category]) {
              skillGroups[skill.category] = [];
          }
          skillGroups[skill.category].push(skill);
      });

      // Position category nodes using Fibonacci sphere distribution
      const categoryCount = Object.keys(skillGroups).length;
      const categoryPositions = fibonacciSphere(categoryCount, 25); // Increased radius
      
      // Create and position category nodes
      Object.entries(skillGroups).forEach(([category, skills], i) => {
          const node = window._loadedModels[category].clone();
          node.position.copy(categoryPositions[i]);
          node.userData = { type: 'category', category, skills, _seed: Math.random() * 100 };
          galaxyGroup.add(node);
          categoryNodes.push(node);

          // Create and position skill nodes around their category
          const skillPositions = fibonacciSphere(skills.length, 6 + Math.random() * 2); // Tighter sphere
          skills.forEach((skill, j) => {
              const skillNode = window._loadedModels.skill.clone();
              const pos = skillPositions[j].clone().add(node.position);
              skillNode.position.copy(pos);
              
              const orbitRadius = skillPositions[j].length();
              const orbitSpeed = (Math.random() * 0.004 + 0.001) * (Math.random() > 0.5 ? 1 : -1);
              
              skillNode.userData = { 
                  type: 'skill', 
                  ...skill,
                  parent: node,
                  _seed: Math.random() * 10,
                  orbit: {
                      center: node.position,
                      radius: orbitRadius,
                      angle: Math.atan2(skillPositions[j].z, skillPositions[j].x),
                      speed: orbitSpeed
                  }
              };
              galaxyGroup.add(skillNode);
              skillNodes.push(skillNode);
              
              // Create connection line
              createConnection(node, skillNode);
              
              // Create floating label
              const label = document.createElement('div');
              label.className = 'floating-label';
              label.textContent = skill.title;
              document.body.appendChild(label);
              labels.set(skillNode.uuid, label);
          });
      });

      // Create connections between category nodes
      categoryNodes.forEach((node, i) => {
          const nextNode = categoryNodes[(i + 1) % categoryNodes.length];
          createConnection(node, nextNode);
      });
    }

    // ---------------------------
    // Starfield
    // ---------------------------
    function createStarfield(){
      const g = new THREE.BufferGeometry(); 
      const count = 1600;
      const pos = new Float32Array(count*3);
      
      for(let i=0;i<count;i++){
        const r = 100 + Math.random()*600;
        const theta = Math.random()*Math.PI*2; 
        const phi = Math.acos(2*Math.random()-1);
        
        pos[i*3]   = r*Math.sin(phi)*Math.cos(theta);
        pos[i*3+1] = r*Math.sin(phi)*Math.sin(theta);
        pos[i*3+2] = r*Math.cos(phi);
      }
      
      g.setAttribute('position', new THREE.BufferAttribute(pos,3));
      g.computeBoundingSphere();
      
      const mat = new THREE.PointsMaterial({ 
        size: 1.1, 
        color: 0xdfefff,
        transparent: true,
        opacity: 0.9
      });
      
      stars = new THREE.Points(g, mat); 
      scene.add(stars);
    }

    // ---------------------------
    // Interaction helpers
    // ---------------------------
    let isPointerDown=false, lastPointer={x:0,y:0}, rotateVel={x:0,y:0};
    function setupDragControls(){
      // simple drag to rotate the galaxyGroup
      renderer.domElement.addEventListener('pointerdown', (e)=>{ isPointerDown=true; lastPointer.x=e.clientX; lastPointer.y=e.clientY; renderer.domElement.style.cursor='grabbing'; });
      renderer.domElement.addEventListener('pointerup', ()=>{ isPointerDown=false; renderer.domElement.style.cursor='default'; });
      renderer.domElement.addEventListener('pointermove', (e)=>{ if(isPointerDown){ const dx=(e.clientX-lastPointer.x)*0.002; const dy=(e.clientY-lastPointer.y)*0.002; galaxyGroup.rotation.y += dx; galaxyGroup.rotation.x += dy; rotateVel.x=dx; rotateVel.y=dy; lastPointer.x=e.clientX; lastPointer.y=e.clientY } });
    }

    function onPointerDown(){ isPointerDown=true }
    function onPointerUp(){ isPointerDown=false }

    // Mouse move & hover
    let lastIntersect = null;
    function onMouseMove(event){
      const rect = renderer.domElement.getBoundingClientRect();
      mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

      if (isPointerDown) return; // Don't raycast while dragging

      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(galaxyGroup.children, true); // Intersect children

      if(intersects.length > 0){
        const obj = intersects[0].object.userData.type ? intersects[0].object : (intersects[0].object.parent.userData.type ? intersects[0].object.parent : intersects[0].object.parent.parent);
        if(obj.userData.type === 'core') return;

        if(lastIntersect && lastIntersect !== obj){ restoreHighlight(lastIntersect); }
        highlightNode(obj);
        lastIntersect = obj;
      } else {
        if(lastIntersect) { restoreHighlight(lastIntersect); lastIntersect=null; }
        hideFloatingLabel();
        if(!focusMode) document.getElementById('info-panel').classList.remove('visible');
      }
    }

    function onClick(){
      if(lastIntersect){ 
        const obj = lastIntersect; 
        if(obj.userData.type==='category'){ 
          if(focusMode && focusedNode===obj) exitFocusMode(); 
          else enterFocusMode(obj); 
        } else if(obj.userData.type==='skill'){ 
          enterSkillFocus(obj);
        } 
      }
    }

    // Highlight/hover visuals
    function highlightNode(obj){
      if(!obj || obj.userData.isHighlighted) return;
      obj.userData.isHighlighted = true;
      gsap.killTweensOf(obj.scale);
      const s = obj.userData.type==='category' ? 1.18 : 1.25;
      gsap.to(obj.scale, { x:s, y:s, z:s, duration:0.25, ease:'power2.out'});
      
      obj.traverse((child) => {
        if (child.isMesh && child.material && child.material.emissive) {
          child.userData.originalEmissive = child.material.emissiveIntensity;
          gsap.to(child.material, { emissiveIntensity: 0.9, duration: 0.22 });
        }
      });

      if(obj.userData.type==='category'){
        showCategoryInfo(obj.userData.category, obj.userData.skills, obj);
      }
      if(obj.userData.type==='skill'){
        showFloatingLabel(obj, labels.get(obj.uuid));
      }
    }

    function restoreHighlight(obj){
      if(!obj || !obj.userData.isHighlighted) return;
      obj.userData.isHighlighted = false;
      gsap.killTweensOf(obj.scale);
      gsap.to(obj.scale, { x:1,y:1,z:1, duration:0.35, ease:'power3.out'});
      
      obj.traverse((child) => {
        if (child.isMesh && child.material && child.material.emissive) {
          gsap.to(child.material, { emissiveIntensity: child.userData.originalEmissive || 0.28, duration: 0.35 });
        }
      });
      
      hideFloatingLabel();
    }

    function restoreAll(){
      categoryNodes.forEach(n=>{ 
        n.traverse((child) => {
          if (child.isMesh) {
            child.material.opacity = 1;
            child.material.transparent = false;
          }
        });
        gsap.to(n.scale,{x:1,y:1,z:1,duration:0.4}); 
      });
      skillNodes.forEach(n=>{ 
        n.traverse((child) => {
          if (child.isMesh) {
            child.material.opacity = 1;
            child.material.transparent = false;
          }
        });
        gsap.to(n.scale,{x:1,y:1,z:1,duration:0.4}); 
      });
      connections.forEach(c=> c.material.opacity = showConnections ? 0.4 : 0);
      document.getElementById('info-panel').classList.remove('visible');
    }

    // ---------------------------
    // Focus / zoom
    // ---------------------------
    function enterFocusMode(node){
      focusMode = true; focusedNode = node;
      // dim others
      categoryNodes.forEach(n=>{ 
        if(n!==node){ 
          n.traverse((child) => {
            if (child.isMesh) {
              child.material.transparent = true;
              gsap.to(child.material, {opacity:0.1, duration:0.5});
            }
          });
        } else { 
          gsap.to(n.scale, {x:1.4,y:1.4,z:1.4, duration:0.6}); 
        } 
      });
      skillNodes.forEach(s=>{ 
        if(s.userData.parent===node){ 
          gsap.to(s.scale, {x:1.25,y:1.25,z:1.25,duration:0.35}); 
          s.traverse((child) => {
            if (child.isMesh) {
              child.material.transparent = false;
              gsap.to(child.material, {opacity:1,duration:0.5});
            }
          });
        } else { 
          s.traverse((child) => {
            if (child.isMesh) {
              child.material.transparent = true;
              gsap.to(child.material, {opacity:0.08,duration:0.5});
            }
          });
        } 
      });
      connections.forEach(c=> gsap.to(c.material, {opacity:0.09,duration:0.4}));

      showCategoryInfo(node.userData.category, node.userData.skills, node);
      document.getElementById('focus-mode').textContent='Exit Focus';

      const target = node.position.clone().multiplyScalar(0.8); target.y += 6; target.z += 20;
      gsap.to(camera.position, { x: target.x, y: target.y, z: target.z, duration: 1.4, ease:'power2.out' });
      gsap.to(controls.target, { x: node.position.x, y: node.position.y, z: node.position.z, duration: 1.4, ease:'power2.out' });
    }

    function exitFocusMode(){ 
      focusMode=false; focusedNode=null; 
      restoreAll(); 
      document.getElementById('focus-mode').textContent='Focus'; 
      gsap.to(camera.position,{x:0,y:18,z:70,duration:1.1,ease:'power2.out'}); 
      gsap.to(controls.target, { x: 0, y: 0, z: 0, duration: 1.1, ease:'power2.out' });
    }

    function enterSkillFocus(skillNode){
      focusMode=true; focusedNode=skillNode;
      showFloatingLabel(skillNode, labels.get(skillNode.uuid));
      // soften everything else
      categoryNodes.forEach(n=> {
        n.traverse((child) => {
          if (child.isMesh) {
            child.material.transparent = true;
            gsap.to(child.material, {opacity:0.1, duration:0.4});
          }
        });
      });
      skillNodes.forEach(s=>{ 
        if(s!==skillNode) {
          s.traverse((child) => {
            if (child.isMesh) {
              child.material.transparent = true;
              gsap.to(child.material,{opacity:0.12,duration:0.4});
            }
          });
        } else {
          gsap.to(s.scale,{x:1.6,y:1.6,z:1.6,duration:0.4}); 
          s.traverse((child) => {
            if (child.isMesh) {
              child.material.transparent = false;
              gsap.to(child.material, {opacity:1,duration:0.4});
            }
          });
        }
      });
      
      const target = skillNode.position.clone().multiplyScalar(0.9); target.y+=3; target.z+=14;
      gsap.to(camera.position,{x:target.x,y:target.y,z:target.z,duration:1.0,ease:'power2.out'});
      gsap.to(controls.target, { x: skillNode.position.x, y: skillNode.position.y, z: skillNode.position.z, duration: 1.0, ease:'power2.out' });
    }

    // ---------------------------
    // Info Panel & Labels
    // ---------------------------
    function showCategoryInfo(category, skills, node){
      const panel = document.getElementById('info-panel');
      document.getElementById('panel-title').textContent = category;
      const latest = skills.slice().sort((a,b)=> new Date(b.date)-new Date(a.date))[0];
      document.getElementById('panel-meta').textContent = `${skills.length} skills · latest — ${latest? formatDate(latest.date):'—'}`;
      const list = document.getElementById('skills-list'); list.innerHTML='';
      skills.slice(0,50).forEach(s=>{
        const row = document.createElement('div'); row.className='skill-row';
        const dot = document.createElement('div'); dot.className='skill-dot'; dot.style.background = '#' + (categoryColors[category]||0xffffff).toString(16).padStart(6,'0');
        const t = document.createElement('div'); t.className='skill-title'; t.textContent = s.title;
        const d = document.createElement('div'); d.className='skill-date'; d.textContent = formatDate(s.date);
        row.appendChild(dot); row.appendChild(t); row.appendChild(d); list.appendChild(row);
      });
      panel.classList.add('visible');
    }

    function showFloatingLabel(node, el){
      if(!el) return; 
      el.style.display='block'; 
      gsap.to(el, { opacity: 1, duration: 0.2 });
      const p = node.position.clone().project(camera);
      const x = (p.x * 0.5 + 0.5) * innerWidth;
      const y = (-p.y * 0.5 + 0.5) * innerHeight - 18;
      el.style.left = `${x}px`; el.style.top = `${y}px`;
    }
    function hideFloatingLabel(){ 
      labels.forEach(l=> {
        gsap.to(l, { opacity: 0, duration: 0.2, onComplete: () => { l.style.display = 'none'; } });
      }); 
    }

    // ---------------------------
    // Resize
    // ---------------------------
    function onResize(){ 
      camera.aspect = innerWidth/innerHeight; 
      camera.updateProjectionMatrix(); 
      renderer.setSize(innerWidth, innerHeight); 
    }

    // ---------------------------
    // Animation loop
    // ---------------------------
    function animate(){
      requestAnimationFrame(animate);
      
      const t = performance.now()*0.001;

      // rotation
      if(isRotating && !isPointerDown) galaxyGroup.rotation.y += 0.0006; // Slower rotation

      // subtle bobbing for categories
      categoryNodes.forEach((n,i)=>{
        const seed = n.userData._seed || i;
        n.position.y += Math.sin(t*0.6 + seed)*0.0018; // Bobbing
        if (!n.userData.isHighlighted && !focusMode) {
          const s = 1 + Math.sin(t*0.8 + seed)*0.02; // Pulsing
          n.scale.set(s,s,s);
        }
      });
      
      // skill nodes orbit around parent
      skillNodes.forEach(s=>{
        const o = s.userData.orbit; if(!o) return;
        o.angle += o.speed * (isRotating? 1 : 0.6);
        const cx = o.center.x + Math.cos(o.angle) * o.radius;
        const cz = o.center.z + Math.sin(o.angle) * o.radius;
        const cy = o.center.y + Math.sin(o.angle*0.7 + s.userData._seed)*0.6;
        s.position.set(cx, cy, cz);
        
        // update associated HTML label (if visible)
        const el = labels.get(s.uuid); 
        if(el && el.style.display==='block') showFloatingLabel(s, el);
      });

      // gentle starfield drift
      if(stars) stars.rotation.y += 0.00012;

      controls.update(); // Update orbit controls
      renderer.render(scene, camera);
    }

    // ---------------------------
    // Boot
    // ---------------------------
    init();
  </script>
</body>
</html>